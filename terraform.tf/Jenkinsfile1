pipeline {
    agent any

    parameters {
        string(name: 'TARGET_USER', defaultValue: 'vmuser', description: 'Target VM SSH username')
        password(name: 'TARGET_PASS', defaultValue: 'YourPasswordHere', description: 'Target VM password (used once to setup passwordless)')
        text(name: 'Inventory', defaultValue: '', description: 'List of target VM IPs, one per line')
    }

    stages {
        stage ("Target VMs are added to ansible inventory.ini file") {
            steps {
                script {
                    sh '''
                    echo "[dev]" > /tmp/inventory.ini
                    IFS=$'\\n'
                    for ip in $Inventory; do
                        echo "$ip" >> /tmp/inventory.ini
                    done
                    echo "Inventory file ready"
                    '''
                }
            }
        }

        stage ("Passwordless authentication") {
            steps {
                script {
                    sh '''
                    # Creating .ssh folder with execute permissions
                    mkdir -p ~/.ssh
                    chmod 700 ~/.ssh

                    # Generating ssh keys
                    yes | ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa 
                    echo "ssh key generated successfully"

                    # Copy the public key to each host in inventory file
                    for host in $(grep -v "^\\[" /tmp/inventory.ini); do
                        sshpass -p "${TARGET_PASS}" ssh-copy-id -o StrictHostKeyChecking=no ${TARGET_USER}@$host
                    done
                    '''
                }
            }
        }
    }
}