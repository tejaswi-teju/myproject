pipeline {
    agent any

    environment {
        DOCKERHUB_CREDENTIALS = credentials("dockerhub-credentials")
        IMAGE = "tejaswi4268/myproject"
        TAG = "latest"
        CONTAINER_NAME = "my-own-container"
        CONTAINER_PORT  = "80"
        HOST_PORT = "8080"
    }
    

    stages {
        stage ("checkout scm") {
            steps {
                git "https://github.com/tejaswi-teju/myproject.git"
            }
        }

        stage ("Build Dockerfile") {
            steps {
                sh "docker build -t myapp:latest ./terraform.tf"
            }
        }

        stage ("Push to Dockerhub") {
            steps {
                sh '''

                # tag the local image with dockerhub user and repo names
                docker tag myapp:latest $IMAGE:$TAG

                # login to dockehub 
                echo "$DOCKERHUB_CREDENTIALS_PSW" | docker login -u "$DOCKERHUB_CREDENTIALS_USR" --password-stdin
                
                # Push the image to dockerhub
                docker push $IMAGE:$TAG
                '''
            }
        }

        /*stage ("Push Image to AWS ECR") {
            steps {
                sh ""
            }
        }*/
        stage ("deploy to EC2 instance") {
            steps{
                sh "ansible-playbook -i /etc/ansible/inventory.ini terraform.tf/deployment.yml --extra-vars 'image=${IMAGE} tag=${TAG} container_name=${CONTAINER_NAME} host_port=${HOST_PORT} container_port=${CONTAINER_PORT}'"
            }
        }
    }
}